# Спецификация `BDSF`[^1] 0.4
## `1.` Задачи
1. Файлы в BDSF должны занимать как можно меньше места.
   > Любой файл данного формата должен занимать наименьшее кол-во места на диске. Предпочтительно, чтобы он занимал места меньше, чем `BSON`.
2. Файлы BDSF должны быть лёгкими для чтения и записи во всех смыслах (подразумевается программный код).
   > Программа, проводящая операции над файлом BDSF, **НЕ** должна сильно нагружать систему.
3. У файла должны отсутствовать ограничения на размер.
   > Несмотря на задачу `#1.1.`, данный формат не должен иметь ограничений по размеру данных.
4. Должен подходить для нескольких целей.
   > Данный формат должен подходить как минимум для следующих целей: `Хранение данных (несколько документов)` и `Передача данных по сети`.

## `2.` Хранение
### `2.1.` Основной формат
Первый байт файла отвечает за указание типа хранения данных.

Если его значение это `01` (1), то используется формат хранения данных в нескольких документах:
```py
File {
    Byte        type      (1);
    Path[]      paths     (N);
    Document[]  documents (N);
}
```
> *Таблица `#1`*
> Название блока | Тип          | Длина (байты : биты) | Описание
> -------------- | ------------ | -------------------- | -------------------------------------------------------
> `type`         | `Byte`       | `1 : 8`              | 1 байт, указывающий тип хранения 
> `paths`        | `Path[]`     | `N : B * 8`[^2]         | Список путей к документам (пишется без указания типа)
> `documents`    | `Document[]` | `N : B * 8`[^2]         | Список документов (пишется без указания типа)

Если же данный байт обнулён (значение `00`, 0), то используется формат передачи данных по сети (один документ):
```py
File {
    Byte     type     (1);
    Document document (N);
}
```

### `2.2.` Начальные типы (`Path`, `Document`)
#### `2.2.1.` Path
> `BDSFT:<тип>` обозначает какой-либо тип из пункта `2.4.`
```py
Path {
    BDSFT:TV    key         (1 + N);
    BDSFT:TV[N] coordinates (1 + N);
}
```
> *Таблица `#2`*
> Название блока | Тип          | Длина (байты : биты)   | Описание
> -------------- | ------------ | ---------------------- | ---------------------------------------------------------------------------------------
> `key`          | `BDSFT:TV`   | `1 + N : 8 + (B * 8)`[^2] | Ключ типа из пункта `2.3.`, также обозначает название документа
> `paths`        | `Path[]`     | `1 + N : 8 + (B * 8)`[^2] | Кол-во байт, после которого начинается блок с данным документом

#### `2.2.2.` Document
> `BDSFT:<тип>` обозначает какой-либо тип из пункта `2.4.`
```py
Document {
    Byte      BOD = 0 (1);
    BDSFT:KTV data    (N);
    Byte      BOD = 0 (1);
```
> *Таблица `#3`*
> Название блока | Тип          | Длина (байты : биты) | Описание
> -------------- | ------------ | -------------------- | ---------------------------------------------------------------------------------------
> `BOD`          | `Byte`       | `1 : 8`              | Всегда `00`, сигнатура конца и края (боков) документа
> `data`         | `BDSFT:KTV`  | `N : B * 8`[^2]         | Пары ключ:значение (`key:value`)

### `2.3.` Типы данных
> `BDSFT:<тип>` обозначает какой-либо тип из пункта `2.4.`
> 
Тип                | Длина (байты : биты) | Диапозон                  | Байт-код | Формат
------------------ | -------------------- | ------------------------- | -------- | ----------------------------
`Byte`             | `1 : 8`              | `-128 - 127`              | `01`     | `-`
`UInt8`            | `1 : 8`              | `0 - 255`                 | `02`     | `-`
`Int16`            | `2 : 16`             | `-2¹⁵+1 - 2¹⁵-1`          | `03`     | `HEX (big endian, signed)`
`UInt16`           | `2 : 16`             | `0 - 2¹⁶-1`               | `04`     | `HEX (big endian, unsigned)`
`Int32`            | `4 : 32`             | `-2³¹+1 - 2³¹-1`          | `05`     | `HEX (big endian, signed)`
`UInt32`           | `4 : 32`             | `0 - 2³²-1`               | `06`     | `HEX (big endian, unsigned)`
`Int64`            | `8 : 64`             | `-2⁶³+1 - 2⁶³-1`          | `07`     | `HEX (big endian, signed)`
`UInt64`           | `8 : 64`             | `0 - 2⁶⁴-1`               | `08`     | `HEX (big endian, unsigned)`
`Int128`           | `16 : 128`           | `-2¹²⁷+1 - 2¹²⁷-1`        | `09`     | `HEX (big endian, signed)`
`UInt128`          | `16 : 128`           | `0 - 2¹²⁸-1`              | `0A`     | `HEX (big endian, unsigned)`
`Float`            | `4 : 32`             | `~ 6 - 9 .` (`2.3/1`)     | `0B`     | `IEEE 754-2019`
`Double`           | `8 : 64`             | `~ 15 - 17 .` (`2.3/1`)   | `0C`     | `IEEE 754-2019`
`Decimal`          | `16 : 128`           | `28 - 29 .` (`2.3/1`)     | `0D`     | `IEEE 754-2019`
`Boolean`          | `1 : 8`              | `1 - 8`                   | `0E`     | `00 = false; 01 = true`
`String`           | `N : B * 8`[^2]         | `-`                       | `0F`     | `c-string`
`Array`            | `N : B * 8`[^2]         | `-`                       | `10`     | `2.3/2`
`Dictionary`       | `N : B * 8`[^2]         | `-`                       | `11`     | `2.3/3`
`Timestamp`        | `4 : 32`             | `0 - 2147483647`          | `12`     | `Unix Timestamp`
`Timestamp64`      | `8 : 64`             | `0 - 9223372036854775807` | `13`     | `64-bit Timestamp`
`Array[Type]`      | `N : B * 8`[^2]         | `-`                       | `14`     | `2.3/4`
`Dictionary[Type]` | `N : B * 8`[^2]         | `-`                       | `15`     | `2.3/5`
`Null`             | `0 : 0`              | `0 - 0`                   | `16`     | `-`
`ItemID`           | `16 : 128`           | `Byte[16]`                | `17`     | `На данный момент не используется`
`PNG Image`        | `N : B * 8`[^2]         | `-`                       | `18`     | `2.3/6`

> #### Примечание `2.3/1`
> `.` - Обозначает "чисел после точки"

> #### Примечание `2.3/2`
> Данный тип состоит из двух частей
> 1. Содержимое списка в формате `BDSFT:TV`
> 2. Сигнатура конца списка (всегда `00`)

> #### Примечание `2.3/3`
> Данный тип состоит из двух частей
> 1. Содержимое словаря в формате `BDSFT:KTV`
> 2. Сигнатура конца словаря (всегда `00`)

> #### Примечание `2.3/4`
> Данный тип состоит из трёх частей
> 1. 1 байт, который обозначает тип, которого будет всё содержимое массива
> 2. Содержимое массива в формате `BDSFT:V`
> 3. Сигнатура конца списка (всегда `00`)

> #### Примечание `2.3/5`
> Данный тип состоит из трёх частей
> 1. 1 байт, который обозначает тип, которого будет всё содержимое словаря
> 2. Содержимое словаря в формате `BDSFT:KV`
> 3. Сигнатура конца словаря (всегда `00`)

> #### Примечание `2.3/6`
> Данный тип это тот же самый PNG, но
> 1. В начале не должно быть PNG сигнатуры
> 2. В блоке `IHDR` отсутствуют поля: `Метод сжатия` и `Метод фильтрации`
> 3. Отсутствуют блок `IEND`

### `2.4.` Формат записи пар ключ-значение
> У всех документов используется следуящяя запись: KTV
> 
> Формат записи: `<chars>[\[<mtype>\]]`

**Значения:**
- `chars` - Символы, указывающие на блоки данных
- `mtype` - Основной тип

**Символы (`chars`):**
- `K` - Ключ, формата TV данного пукнта, N байт
- `T` - Тип значения, 1 байт
- `V` - Само значение, N байт

**Основные типы (`mtype`):**
- `N` - `Int16`, `Int32`, `Int64`, `Int128`, `UInt8`, `UInt16`, `UInt32`, `UInt64` и `UInt128`
- `F` - `Float`, `Double` и `Decimal128`

[^1]: BDSF *(**англ.** Binary Data Storage Format)* - Двоичный формат хранения данных.
[^2]: `N` = Любое число; `B` = Число байт.
